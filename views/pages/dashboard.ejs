<!DOCTYPE html>

<html>
	<head>
		<% include ../partials/head %>
	</head>
	<body class="hold-transition skin-purple sidebar-mini" ng-app="acrcsr-dashboard">
		<div class="wrapper">
			<% include ../partials/header %>
			<% include ../partials/sidebar %>
			<!-- Content Wrapper. Contains page content -->
			<div class="content-wrapper" ng-controller="dashboardController">
				<!-- Content Header (Page header) -->
				<section class="content-header">
					<h1>Management Dashboard</h1>
					<ol class="breadcrumb">
						<li><a href="./dashboard"><i class="fa fa-dashboard"></i> Home</a></li>
						<li class="active">Management Dashboard</li>
					</ol>
				</section>

				<!-- Main content -->
				<section class="content">

					<!-- Page Content -->
					<div class="row">
						<div class="col-lg-3 col-xs-6">
							<!-- small box -->
							<div class="small-box bg-aqua">
								<div class="inner">
									<h3>{{summary.calls| shownum}}</h3>
									<h4>Calls Waiting</h4>
								</div>
								<div class="icon">
									<i class="ion ion-ios-telephone"></i>
								</div>
							</div>
						</div><!-- ./col -->
						<div class="col-lg-3 col-xs-6">
							<!-- small box -->
							<div class="small-box bg-green">
								<div class="inner">
									<h3>{{summary.completed| shownum}}</h3>
									<h4>Calls Handled</h4>
								</div>
								<div class="icon">
									<i class="ion ion-checkmark"></i>
								</div>
							</div>
						</div><!-- ./col -->
						<div class="col-lg-3 col-xs-6">
							<!-- small box -->
							<div class="small-box bg-yellow">
								<div class="inner">
									<h3>{{summary.avgholdtime| shownum}}</h3>
									<h4>Average Hold Time (min)</h4>
								</div>
								<div class="icon">
									<i class="ion ion-clock"></i>
								</div>
							</div>
						</div><!-- ./col -->
						<div class="col-lg-3 col-xs-6">
							<!-- small box -->
							<div class="small-box bg-red">
								<div class="inner">
									<h3>{{summary.abandoned| shownum}}</h3>
									<h4>Calls Abandoned</h4>
								</div>
								<div class="icon">
									<i class="ion ion-close-circled"></i>
								</div>
							</div>
						</div><!-- ./col -->
					</div><!-- /.row -->

					<!-- Charts -->
					<div class="row">
						<div class="col-md-4">
							<!-- LINE CHART -->
							<div class="box">
								<div class="box-header with-border">
									<h3 class="box-title">Average Calls In Queue <small>(10 min. intervals)</small>
									</h3>
									<div class="box-tools pull-right">
										<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
										</button>
									</div>
								</div>
								<div class="box-body">
									<div id="queueSizeLineChart" style="height:250px"></div>
								</div>
								<!-- /.box-body -->
							</div>
						</div>
					</div>

					<!-- Queue Information Box -->
					<div class="row">
						<div class="col-lg-12">
							<div class="box">
								<div class="box-header with-border">
									<h3 class="box-title">Queue Information</h3>
									<div class="box-tools pull-right">
										<button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
									</div>
								</div><!-- /.box-header -->
								<div class="box-body table-responsive no-padding" style="max-height: 250px; overflow-y: scroll">
									<table class="table table-hover">
										<tr>
											<th class="text-center">Queue</th>
											<th class="text-center">Logged In</th>
											<th class="text-center">Available Agents</th>
											<th class="text-center">Current Calls</th>
											<th class="text-center">Total Calls</th>
											<th class="text-center">Calls Handled</th>
											<th class="text-center">Calls Abandoned</th>
											<th class="text-center">Talk Time (min)</th>
											<th class="text-center">Hold Time (min)</th>
											<th class="text-center">Longest Hold Time (min)</th>
										</tr>
										<tr ng-repeat="q in Queues">
											<td><span class="queue-info">{{q.queue}}</span></td>
											<td id="qname" class="text-center"><span class="queue-info">{{q.loggedin}}</span></td>
											<td class="text-center"><span class="queue-info">{{q.available}}</span></td>
											<td class="text-center"><span class="queue-info">{{q.callers}}</span></td>
											<td class="text-center"><span class="queue-info">{{q.calls}}</span></td>
											<td class="text-center"><span class="queue-info">{{q.completed}}</span></td>
											<td class="text-center"><span class="queue-info">{{q.abandoned}}</span></td>
											<td class="text-center"><span class="queue-info">{{q.talktime}}</span></td>
											<td class="text-center"><span class="queue-info">{{q.holdtime}}</span></td>
											<td class="text-center"><span class="queue-info">{{q.longestholdtime}}</span></td>
										</tr>
									</table>
								</div><!-- /.box-body -->
							</div><!-- /.box -->
						</div><!-- ./col -->
					</div><!-- ./Queue Information Table -->

					<!-- Call Agent Summary Table -->
					<div class="row">
						<div class="col-lg-12">
							<div class="box">
								<div class="box-header with-border">
									<h3 class="box-title">Call Agent Summary</h3>
									<div class="box-tools pull-right">
										<button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
									</div>
								</div><!-- /.box-header -->
								<div id="agentSummary" class="box-body table-responsive no-padding" style="max-height: 250px; overflow-y: scroll">
									<table class="table table-hover">
										<tr>
											<th class="text-center">Call Agent</th>
											<th class="text-center">Registered Ext.</th>
											<th class="text-center">Registered Queue</th>
											<th class="text-center">Calls Completed</th>
											<th class="text-center">Average Call Time (min)</th>
											<th class="text-center">Talk Time (min)</th> 
											<!-- Placeholders for a future function -->
											<!-- <th class="text-center"Calls Abandoned</th> -->
											<!-- <th class="text-center">Hang-Ups</th> -->
											<!-- <th class="text-center">Ring No Answer</th> -->
											<th class="text-center">Status</th>
										</tr>
										<tr ng-repeat="a in Agents" highlight-on-change="{{a.help}}" ng-click="a.help = 'no'">
											<td><span class="queue-info">{{a.name}}</span></td>

											<td class="text-center"><span class="queue-info">{{a.agent}}</span></td>
											<td class="text-center"><span class="queue-info">{{a.queue}}</span></td>
											<td class="text-center"><span class="queue-info">{{a.callstaken}}</span></td>
											<td class="text-center"><span class="queue-info">{{a.avgtalktime}}</span></td>
											<td class="text-center"><span class="queue-info">{{a.talktime}}</span></td>
											<td class="text-center"><span class="queue-info">{{a.status}}</span></td>
										</tr>
									</table>
								</div><!-- /.box-body -->
							</div><!-- /.box -->
						</div>
					</div><!-- ./Call Agent Summary Table -->

					<!-- Resource Status Table -->
					<div class="row">
						<div class="col-lg-4">
							<div class="box">
								<div class="box-header">
									<h3 class="box-title">Resource Status Table</h3>
									<br>
									<small id="resourceupdated">Last updated:</small>
									<div class="box-tools pull-right">
										<button id="statusRefreshBtn" class="btn btn-box-tool" onclick="refreshResourceStatus()"><i id="statusRefreshIcon" class="fa fa-refresh"></i></button>
										<button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
									</div>
								</div><!-- /.box-header -->
								<div class="box-body table-responsive no-padding">
									<table id="resourcetable" class="table table-hover">
										<!-- place holder for resourcetable which will update later -->
									</table>
								</div><!-- /.box-body -->
							</div><!-- /.box -->
						</div>
					</div><!-- ./Resource Status Table -->

					<div class="row">
						<div class="col-md-12" style="visibility:hidden; text-align: center">
							<button id="reset"  type="button" class="btn bg-navy btn-flat margin" onclick="resetAllCounters()" >Reset All Counters</button>
						</div>
					</div>
				</section><!-- /.content -->
			</div><!-- /.content-wrapper -->
			<% include ../partials/footer %>
		</div><!-- ./wrapper -->
		
		<!-- REQUIRED JS SCRIPTS -->
		<!-- ChartJS -->
		<script type="text/javascript" src="./bower_components/AdminLTE/plugins/chartjs/Chart.min.js"></script>
		<!-- flot -->
		<script type="text/javascript" src="./bower_components/AdminLTE/plugins/flot/jquery.flot.min.js"></script>
		<script type="text/javascript" src="./bower_components/AdminLTE/plugins/flot/jquery.flot.categories.min.js"></script>
		<script type="text/javascript" src="./bower_components/AdminLTE/plugins/flot/jquery.flot.time.min.js"></script>
		<script type="text/javascript" src="public/js/jquery.flot.axislabels.js"></script>

		<!-- Angular -->
		<script type="text/javascript" src="./bower_components/angular/angular.min.js"></script>
		<!-- Angular-Route -->
		<script type="text/javascript" src="./bower_components/angular-route/angular-route.min.js"></script>
		<!-- Angular Bootstrap -->
		<script type="text/javascript" src="./bower_components/angular-bootstrap/ui-bootstrap-tpls.min.js"></script>

		<!-- Angular Controllers -->
		<script type="text/javascript" src="public/js/controllers/dashboard.js"></script>
		<script type="text/javascript" src="public/js/controllers/filters.js"></script>
		<script type="text/javascript" src="public/js/services/csrservices.js"></script>
		<script type="text/javascript" src="public/js/core-dashboard.js"></script>

		<script type="text/javascript">
			var socket;

			$.ajax({
				url: './token',
				type: 'GET',
				dataType: 'json',
				success: function (data) {
					//alert(JSON.stringify(data));
					if (data.message === "success") {
						socket = io.connect('https://' + window.location.host, {
							path: '/ManagementPortal/socket.io',
							query: 'token=' + data.token,
							forceNew: true
						});		

						socket.emit('register-manager', {"hello": "hello"});
						socket.on('resource-status', function (data) {
							$('#statusRefreshIcon').removeClass('fa-spin');
							$('#statusRefreshBtn').prop("disabled", false);
							if (data.error === undefined) {

								var timestamp = moment(data.timestamp).format('h:mm:ss A')
								$('#resourceupdated').html("Last Updated: " + timestamp);
								$('#resourcetable').html('');
								$('#resourcetable').append("<tr><th>System</th><th>Status</th></tr>");

								for (i = 0; i < data.resources.length; i++) {
									var newRow = document.createElement('tr');
									var resourceName = document.createElement('td');
									var resourceStatus = document.createElement('td');
									var resSpan = document.createElement('span');

									$(resSpan).addClass('label');

									$(resourceName).html(data.resources[i].name);
									$(resSpan).html(data.resources[i].status);

									if (data.resources[i].status) {
										$(resSpan).addClass('label-success');
										$(resSpan).html("Running");
									} else {
										$(resSpan).addClass('label-danger');
										$(resSpan).html("Unavailable");
									}

									$(resourceStatus).append(resSpan);
									$(newRow).append(resourceName);
									$(newRow).append(resourceStatus);

									$('#resourcetable').append(newRow);
								}
							}
						});

						socket.on('metrics', function (data) {
							var target = .5;
							var targetData = createTargetLine(data, target)

							$.plot("#queueSizeLineChart", [data, targetData], {
								lines:{show: true},
								axisLabels: {show: true},
								xaxis: {
									mode: "time",
									minTickSize: [2, "hour"],
									timeformat: "%H:%M",
									axisLabel: "Time"
								},
								yaxis: {
									position: "left",
									axisLabel: "Calls"
								},
								colors: ["#0022FF", "#FF4040"]
							});
						});
					} else {
						//TODO: handle bad connections
					}
				},
				error: function (xhr, status, error) {
					console.log('Error');
					$('#message').text('An Error Occured.');
				}
			});

			$(document).ready(function () {
				$("#sidebardashboard").addClass("active");
			});

			function createTargetLine(data, target) {
				var targetData = [];
				var point = []
				point.push(data[0][0]);
				point.push(target);
				targetData.push(point);
				var point2 = [];
				point2.push(data[data.length - 1][0]);
				point2.push(target);
				targetData.push(point2);
				return targetData;
			}

			function refreshResourceStatus() {
				$('#statusRefreshIcon').addClass('fa-spin');
				$('#statusRefreshBtn').prop("disabled", true);
				socket.emit('resource-status-update', null);
			}

			function resetAllCounters() {
				console.log("reset counters ####");
				$.ajax({
					url: '/resetAllCounters',
					type: 'GET',
					dataType: "json"
				})
			}
		</script>
	</body>
</html>